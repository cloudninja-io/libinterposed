#!/usr/bin/env python
import os.path
import argparse
import subprocess

config = ''

parser = argparse.ArgumentParser(description='Configure `libinterposed` build.')
parser.add_argument('--dest-cpu',
                    action='store',
                    dest='dest_cpu',
                    help='CPU architecture to build for. Valid values are: ia32, x64')
args = parser.parse_args()

arch = args.dest_cpu or subprocess.check_output(['node', '-pe', 'process.arch']).strip()
if arch:
    match = {
        'ia32': '-m32',
        'x86': '-m32',
        'x64': '-m64'
    }

    if not match[arch]:
        print 'Valid values for `--dest-cpu` option are: ia32, x64'
        sys.exit(1)

    config += 'CFLAGS += ' + match[arch] + '\n'

f = open('config.mk', 'w')
f.write(config + '\n')
f.close()
